<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>at</title>
<link rel="stylesheet" type="text/css" href="nimdoc.out.css">

<script type="text/javascript" src="dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}
</script>

</head>
<body onload="main()">
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">at</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<li><a class="reference" id="whyqmark_toc" href="#whyqmark">Why?</a></li>
<li><a class="reference" id="use-cases_toc" href="#use-cases">Use cases</a></li>
<li><a class="reference" id="features_toc" href="#features">Features</a></li>
<li><a class="reference" id="limitations_toc" href="#limitations">Limitations</a></li>
<li><a class="reference" id="usage_toc" href="#usage">Usage</a></li>
<ul class="simple"><li><a class="reference" id="usage-in-memory_toc" href="#usage-in-memory">In Memory</a></li>
<li><a class="reference" id="usage-onminusdisk_toc" href="#usage-onminusdisk">On-Disk</a></li>
</ul><li>
  <a class="reference reference-toplevel" href="#7" id="57">Types</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#At"
    title="At[TTimeToKey; TTable2] = ref object
  trigger*: FutureVar[void]
  t2k*: TTimeToKey
  k2t*: TTable2">At</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">[]=
      <li><a class="reference" href="#%5B%5D%3D%2CAt%2CT%2CDuration"
    title="`[]=`[T](a: At; key: T; d: Duration)">[]=,<wbr>At,<wbr>T,<wbr>Duration</a></li>
  <li><a class="reference" href="#%5B%5D%3D%2CAt%2CT%2CTime"
    title="`[]=`[T](a: At; key: T; t: Time)">[]=,<wbr>At,<wbr>T,<wbr>Time</a></li>

  </ul>
  <ul class="simple nested-toc-section">del
      <li><a class="reference" href="#del%2CAt%2CT"
    title="del[T](a: At; key: T)">del,<wbr>At,<wbr>T</a></li>

  </ul>
  <ul class="simple nested-toc-section">initAt
      <li><a class="reference" href="#initAt%2CTTimeToKey%2CTTable2"
    title="initAt[TTimeToKey, TTable2](t2k: TTimeToKey; k2t: TTable2): At[TTimeToKey,
    TTable2]">initAt,<wbr>TTimeToKey,<wbr>TTable2</a></li>

  </ul>
  <ul class="simple nested-toc-section">next
      <li><a class="reference" href="#next%2CAt"
    title="next(a: At): Time">next,<wbr>At</a></li>

  </ul>
  <ul class="simple nested-toc-section">process
      <li><a class="reference" href="#process%2CAt"
    title="process(a: At): owned(Future[void])">process,<wbr>At</a></li>

  </ul>
  <ul class="simple nested-toc-section">trigger
      <li><a class="reference" href="#trigger%2CAt%2CTime%2CT"
    title="trigger[T](a: At; t: Time; key: T)">trigger,<wbr>At,<wbr>Time,<wbr>T</a></li>
  <li><a class="reference" href="#trigger%2CTime%2CT"
    title="trigger[T](t: Time; key: T)">trigger,<wbr>Time,<wbr>T</a></li>

  </ul>

  </ul>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc"><p>A powerful, lightweight tool to execute code later</p>

<h1><a class="toc-backref" id="whyqmark" href="#whyqmark">Why?</a></h1><p>While the same thing can be accomplished using the standard library's <tt class="docutils literal"><span class="pre"><span class="Identifier">asyncdispatch</span></span></tt>, at stores the values in a table and only uses one future to go through them.</p>
<p>This has a lot of advantages:</p>
<p>Transparency: The timers are all neatly accessible in a table instead of being hidden in the global dispatcher. Several <tt class="docutils literal"><span class="pre"><span class="Identifier">at</span></span></tt> instances can be used to group related timers or timers that do different things. That makes it this much easier to find bugs.</p>
<p>Flexibility: The timers can be easily modified or removed up until they are triggered. You can use any table you like as long as it keeps the keys sorted.</p>
<p>Persistence: Tables don't have to be in-memory. Using a table backed by persistent storage can preserve triggers across program restarts. Data is only ever read one-by-one after a trigger, so startup time is not meaningfully affected. And since the data is used directly off disk, you don't need to worry about whether the in-memory triggers are actually in sync with the on-disk triggers because the disk data is used directly. If you use a memory-mapped persistent table, this doesn't affect performance at all.</p>

<h1><a class="toc-backref" id="use-cases" href="#use-cases">Use cases</a></h1><p><em>Expiring Data</em></p>
<p>A really cool use-case is to remove ephemeral key/value pairs from an (additional) table, especially when persistent storage is used. For example, in a web app, this could be used for things like session key hashes, password reset link hashes, or incomplete form data you don't want to clutter your nice database with but are nice enough to store for your user.</p>
<p><em>Maintenance tasks</em></p>
<p>In most apps, maintenance tasks need to be performed- deleting old data, checking for updates, reminding the user to do stuff or simply doing stuff later. Traditionally, at least for web apps, external timers or special daemons are used, but it greatly simplifies both programming and administration to keep everything in-process.</p>

<h1><a class="toc-backref" id="features" href="#features">Features</a></h1><ul class="simple"><li>Simple-yet-effective implementation designed for tens of thousands of planned triggers using only one future.</li>
<li>BYOT- bring your own table, you have full control over the table or table-like object used to store trigger information so you have full control data is stored. It's also fairly easy to write your own table interface, see the filesystem-storage example.</li>
</ul>

<h1><a class="toc-backref" id="limitations" href="#limitations">Limitations</a></h1><p>The table to look up times <tt class="docutils literal"><span class="pre"><span class="Identifier">t2k</span></span></tt> has to be one that is sorted by the key.</p>
<p>This is currently the case for:</p>
<p>In-Memory tables: <tt class="docutils literal"><span class="pre"><span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">bitcrittree</span></span></tt> (requires some boilerplate), <tt class="docutils literal"><span class="pre"><span class="Identifier">fusion</span><span class="Operator">/</span><span class="Identifier">btreetable</span></span></tt> and <tt class="docutils literal"><span class="pre"><span class="Identifier">pkg</span><span class="Operator">/</span><span class="Identifier">sorta</span></span></tt>.</p>
<p>Persistent tables: <tt class="docutils literal"><span class="pre"><span class="Identifier">pkg</span><span class="Operator">/</span><span class="Identifier">limdb</span></span></tt> (requires supplied type conversion), <tt class="docutils literal"><span class="pre"><span class="Identifier">pkg</span><span class="Operator">/</span><span class="Identifier">nimdbx</span></span></tt> (untested)</p>
<p>Other tables can be of any type.</p>

<h1><a class="toc-backref" id="usage" href="#usage">Usage</a></h1>
<h2><a class="toc-backref" id="usage-in-memory" href="#usage-in-memory">In Memory</a></h2><p>It's often good to stick to the standard library as much as possible, however the only key-sorted table in the standard libary is the <tt class="docutils literal"><span class="pre"><span class="Identifier">CritBitTable</span></span></tt>. This has a somewhat different interface to regular tables, so a bit of boilerplate code is needed to convince it to act like one. Also only strings are supported for the keys, so we have to define some converters. This boilerplate can be omitted for other tables.</p>
<p><pre class="listing"><span class="Comment"># a critbittree requires some boilerplate to be accessed like a regular table</span>
<span class="Keyword">import</span> <span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">asyncdispatch</span><span class="Punctuation">,</span> <span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">os</span><span class="Punctuation">,</span> <span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">times</span><span class="Punctuation">,</span> <span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">tables</span><span class="Punctuation">,</span> <span class="Identifier">std</span><span class="Operator">/</span><span class="Identifier">critbits</span><span class="Punctuation">,</span> <span class="Identifier">at</span><span class="Punctuation">,</span> <span class="Identifier">at</span><span class="Operator">/</span><span class="Identifier">timeblobs</span>

<span class="Comment"># a critbittree requires some boilerplate to be used as a [time: string] table</span>
<span class="Keyword">proc</span> <span class="Identifier">initCritBitTree</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">CritBitTree</span><span class="Punctuation">[</span><span class="Identifier">T</span><span class="Punctuation">]</span> <span class="Operator">=</span>
  <span class="Keyword">discard</span>
<span class="Keyword">iterator</span> <span class="Identifier">keys</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">CritBitTree</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Time</span> <span class="Operator">=</span>
  <span class="Keyword">for</span> <span class="Identifier">k</span> <span class="Keyword">in</span> <span class="Identifier">critbits</span><span class="Operator">.</span><span class="Identifier">keys</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">yield</span> <span class="Identifier">k</span><span class="Operator">.</span><span class="Identifier">blobToTime</span>
<span class="Keyword">proc</span> <span class="Identifier">del</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">tab</span><span class="Punctuation">:</span> <span class="Keyword">var</span> <span class="Identifier">CritBitTree</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">tab</span><span class="Operator">.</span><span class="Identifier">excl</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span>
<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">CritBitTree</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">string</span> <span class="Operator">=</span>
  <span class="Identifier">a</span><span class="Punctuation">[</span><span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span><span class="Punctuation">]</span>
<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">CritBitTree</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">a</span><span class="Punctuation">[</span><span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">s</span>

<span class="Comment"># Now that we've got the critbit behaving like a proper table,</span>
<span class="Comment"># we can get started.</span>

<span class="Comment"># We store our ephemeral data in a regular table. Note it's a `ref`</span>
<span class="Comment"># otherwise the modifications would be made on a copy.</span>

<span class="Keyword">let</span> <span class="Identifier">data</span> <span class="Operator">=</span> <span class="Identifier">newTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Comment"># Now we add a trigger proc that `at` will call.</span>
<span class="Comment"># It accesses `data` as a global, but it can be placed into</span>
<span class="Comment"># a proc to use a closure instead.</span>

<span class="Keyword">proc</span> <span class="Identifier">trigger</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">k</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
    <span class="Identifier">data</span><span class="Operator">.</span><span class="Identifier">del</span> <span class="Identifier">k</span>

<span class="Comment"># Now we can initialize `at`. We make two tables and pass them in.</span>
<span class="Comment"># This allows for a lot of flexibility.</span>
<span class="Keyword">let</span> <span class="Identifier">aa</span> <span class="Operator">=</span> <span class="Identifier">initAt</span><span class="Punctuation">(</span><span class="Identifier">initCritBitTree</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">initTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">Time</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
<span class="Identifier">asyncCheck</span> <span class="Identifier">aa</span><span class="Operator">.</span><span class="Identifier">process</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Comment"># now let's add some data that will be deleted in three seconds</span>
<span class="Identifier">data</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="StringLit">&quot;bar&quot;</span>
<span class="Identifier">expiry</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">initDuration</span><span class="Punctuation">(</span><span class="Identifier">seconds</span><span class="Operator">=</span><span class="DecNumber">3</span><span class="Punctuation">)</span>
</pre></p>
<p>If you don't mind using nimble packages, there is a really nice module <tt class="docutils literal"><span class="pre"><span class="Identifier">btreetables</span></span></tt> in the <tt class="docutils literal"><span class="pre"><span class="Identifier">fusion</span></span></tt> package that can be used.</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">times</span><span class="Punctuation">,</span> <span class="Identifier">at</span><span class="Punctuation">,</span> <span class="Identifier">asyncdispatch</span><span class="Punctuation">,</span> <span class="Identifier">fusion</span><span class="Operator">/</span><span class="Identifier">btreetables</span>
<span class="Keyword">let</span> <span class="Identifier">data</span> <span class="Operator">=</span> <span class="Identifier">newTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span>  <span class="Comment"># this is a btree table too but could be a regular one</span>
<span class="Keyword">proc</span> <span class="Identifier">trigger</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">k</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
    <span class="Identifier">data</span><span class="Operator">.</span><span class="Identifier">del</span> <span class="Identifier">k</span>
<span class="Keyword">let</span> <span class="Identifier">aa</span> <span class="Operator">=</span> <span class="Identifier">initAt</span><span class="Punctuation">(</span><span class="Identifier">newTable</span><span class="Punctuation">[</span><span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">string</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">newTable</span><span class="Punctuation">[</span><span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">Time</span><span class="Punctuation">]</span><span class="Punctuation">(</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Identifier">asyncCheck</span> <span class="Identifier">expiry</span><span class="Operator">.</span><span class="Identifier">process</span>
<span class="Identifier">data</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="StringLit">&quot;bar&quot;</span>
<span class="Identifier">aa</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">initDuration</span><span class="Punctuation">(</span><span class="Identifier">seconds</span><span class="Operator">=</span><span class="DecNumber">3</span><span class="Punctuation">)</span>
</pre></p>
<p>Sorta tables work great too</p>
<p>import times, sorta, at, asyncdispatch, tables var s = initSortedTable<a class="reference external" href="">string, Time</a> var data = newTable<a class="reference external" href="">string, string</a> proc trigger(t: Time, k: string) = data.del k let aa = initAt(initSortedTable<a class="reference external" href="">Time, string</a>, initSortedTable<a class="reference external" href="">string, Time</a>) asyncCheck aa.process data[&quot;foo&quot;] = &quot;bar&quot; aa[&quot;foo&quot;] = initDuration(seconds=3)</p>

<h2><a class="toc-backref" id="usage-onminusdisk" href="#usage-onminusdisk">On-Disk</a></h2><p>Now for the main event- At really shines when it comes to expiring values that are persisted to disk- a key-value database, as there is no need to load the time information from disk into memory storage and keep it in sync- everything stays on disk until there is a trigger.</p>
<p>Just give expiry a table-like interface to the database and you're good to go. As an example, you could create your own filesystem-based persistence layer. That's not particularly fast compared to other options out there but it works and does not require any dependencies.</p>
<p><pre class="listing"><span class="Comment"># TODO: add file system database example</span>
</pre></p>
<p>Most likely, you will prefer to use a tried-and-true key-value store like LMDB- here wrapped into a table-like interface by LimDB:</p>
<p><pre class="listing"><span class="Keyword">import</span> <span class="Identifier">at</span><span class="Punctuation">,</span> <span class="Identifier">os</span><span class="Punctuation">,</span> <span class="Identifier">asyncdispatch</span><span class="Punctuation">,</span> <span class="Identifier">limdb</span><span class="Punctuation">,</span> <span class="Identifier">times</span><span class="Punctuation">,</span> <span class="Identifier">at</span><span class="Operator">/</span><span class="Identifier">timeblobs</span>

<span class="Comment"># LimDB requires some boilerplate because it only supports strings</span>
<span class="Keyword">iterator</span> <span class="Identifier">keys</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Time</span> <span class="Operator">=</span>
  <span class="Keyword">for</span> <span class="Identifier">k</span> <span class="Keyword">in</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">keys</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">)</span><span class="Punctuation">:</span>
    <span class="Keyword">yield</span> <span class="Identifier">k</span><span class="Operator">.</span><span class="Identifier">blobToTime</span>
<span class="Keyword">proc</span> <span class="Identifier">del</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">a</span><span class="Operator">.</span><span class="Identifier">del</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span>

<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">string</span> <span class="Operator">=</span>
  <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span><span class="Punctuation">)</span>
<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Time</span> <span class="Operator">=</span>
  <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Operator">.</span><span class="Identifier">blobToTime</span><span class="Punctuation">)</span>
<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">)</span>
<span class="Keyword">template</span> <span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">:</span> <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Identifier">Database</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">limdb</span><span class="Operator">.</span><span class="Punctuation">`</span><span class="Punctuation">[</span><span class="Punctuation">]</span><span class="Operator">=</span><span class="Punctuation">`</span><span class="Punctuation">(</span><span class="Identifier">a</span><span class="Punctuation">,</span> <span class="Identifier">s</span><span class="Punctuation">,</span> <span class="Identifier">t</span><span class="Operator">.</span><span class="Identifier">timeToBlob</span><span class="Punctuation">)</span>

<span class="Keyword">let</span> <span class="Identifier">data</span> <span class="Operator">=</span> <span class="Identifier">initDatabase</span><span class="Punctuation">(</span><span class="Identifier">getTempDir</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Operator">/</span> <span class="StringLit">&quot;limdb&quot;</span><span class="Punctuation">,</span> <span class="StringLit">&quot;main&quot;</span><span class="Punctuation">)</span>

<span class="Keyword">proc</span> <span class="Identifier">trigger</span><span class="Punctuation">(</span><span class="Identifier">t</span><span class="Punctuation">:</span> <span class="Identifier">Time</span><span class="Punctuation">,</span> <span class="Identifier">k</span><span class="Punctuation">:</span> <span class="Identifier">string</span><span class="Punctuation">)</span> <span class="Operator">=</span>
  <span class="Identifier">data</span><span class="Operator">.</span><span class="Identifier">del</span> <span class="Identifier">k</span>

<span class="Keyword">let</span> <span class="Identifier">aa</span> <span class="Operator">=</span> <span class="Identifier">initAt</span><span class="Punctuation">(</span><span class="Identifier">data</span><span class="Operator">.</span><span class="Identifier">initDatabase</span><span class="Punctuation">(</span><span class="StringLit">&quot;at time-to-key&quot;</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Identifier">data</span><span class="Operator">.</span><span class="Identifier">initDatabase</span><span class="Punctuation">(</span><span class="StringLit">&quot;at key-to-time&quot;</span><span class="Punctuation">)</span><span class="Punctuation">)</span>
<span class="Identifier">asyncCheck</span> <span class="Identifier">aa</span><span class="Operator">.</span><span class="Identifier">process</span><span class="Punctuation">(</span><span class="Punctuation">)</span>

<span class="Identifier">data</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="StringLit">&quot;bar&quot;</span>
<span class="Identifier">aa</span><span class="Punctuation">[</span><span class="StringLit">&quot;foo&quot;</span><span class="Punctuation">]</span> <span class="Operator">=</span> <span class="Identifier">initDuration</span><span class="Punctuation">(</span><span class="Identifier">seconds</span><span class="Operator">=</span><span class="DecNumber">3</span><span class="Punctuation">)</span>
</pre></p>
<p>And this is how this is meant to be used.</p>
</p>
  <div class="section" id="7">
<h1><a class="toc-backref" href="#7">Types</a></h1>
<dl class="item">
<a id="At"></a>
<dt><pre><a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">[</span><span class="Identifier">TTimeToKey</span><span class="Other">;</span> <span class="Identifier">TTable2</span><span class="Other">]</span> <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  <span class="Identifier">trigger</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">FutureVar</span><span class="Other">[</span><span class="Identifier">void</span><span class="Other">]</span>
  <span class="Identifier">t2k</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">TTimeToKey</span>
  <span class="Identifier">k2t</span><span class="Operator">*</span><span class="Other">:</span> <span class="Identifier">TTable2</span>
</pre></dt>
<dd>

A powerful, lightweight tool to execute code later

</dd>

</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<a id="[]=,At,T,Duration"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%5B%5D%3D%2CAt%2CT%2CDuration"><span class="Identifier">`[]=`</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">;</span> <span class="Identifier">d</span><span class="Other">:</span> <span class="Identifier">Duration</span><span class="Other">)</span></pre></dt>
<dd>

Set a trigger relative to now.

</dd>
<a id="[]=,At,T,Time"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%5B%5D%3D%2CAt%2CT%2CTime"><span class="Identifier">`[]=`</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">;</span> <span class="Identifier">t</span><span class="Other">:</span> <span class="Identifier">Time</span><span class="Other">)</span></pre></dt>
<dd>

Set a trigger as an absolute time.

</dd>
<a id="del,At,T"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#del%2CAt%2CT"><span class="Identifier">del</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">)</span></pre></dt>
<dd>

Manually remove a trigger by its key

</dd>
<a id="initAt,TTimeToKey,TTable2"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#initAt%2CTTimeToKey%2CTTable2"><span class="Identifier">initAt</span></a><span class="Other">[</span><span class="Identifier">TTimeToKey</span><span class="Other">,</span> <span class="Identifier">TTable2</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">t2k</span><span class="Other">:</span> <span class="Identifier">TTimeToKey</span><span class="Other">;</span> <span class="Identifier">k2t</span><span class="Other">:</span> <span class="Identifier">TTable2</span><span class="Other">)</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">[</span><span class="Identifier">TTimeToKey</span><span class="Other">,</span>
    <span class="Identifier">TTable2</span><span class="Other">]</span></pre></dt>
<dd>

<p>Initialize an <tt class="docutils literal"><span class="pre"><span class="Identifier">at</span></span></tt> tool to execute code later.</p>
<p>You give it two tables or table-like objects, one to store times and associated keys, in the others the keys are mapped to the times in case they need to be looked up.</p>
<p>The time-to-key table needs to be of the kind that sorts by its keys. critbits works in the standard library, and so does btreetable in fusion.</p>
<p>Persistent table-like objects are often preferred. </p>


</dd>
<a id="next,At"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#next%2CAt"><span class="Identifier">next</span></a><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">Time</span></pre></dt>
<dd>

Internal use, uses the <tt class="docutils literal"><span class="pre"><span class="Identifier">keys</span></span></tt> iterator to get the first time of the times-to-keys table to start waiting.

</dd>
<a id="process,At"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#process%2CAt"><span class="Identifier">process</span></a><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">owned</span><span class="Other">(</span><span class="Identifier">Future</span><span class="Other">[</span><span class="Identifier">void</span><span class="Other">]</span><span class="Other">)</span></pre></dt>
<dd>

Call after initializing to start processing. This sets up the future and waits.

</dd>
<a id="trigger,At,Time,T"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#trigger%2CAt%2CTime%2CT"><span class="Identifier">trigger</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">a</span><span class="Other">:</span> <a href="at.html#At"><span class="Identifier">At</span></a><span class="Other">;</span> <span class="Identifier">t</span><span class="Other">:</span> <span class="Identifier">Time</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">)</span></pre></dt>
<dd>

This is a trigger that allows access to the <tt class="docutils literal"><span class="pre"><span class="Identifier">at</span></span></tt> object. Use with caution. Don't implement both if you don't want both to run.

</dd>
<a id="trigger,Time,T"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#trigger%2CTime%2CT"><span class="Identifier">trigger</span></a><span class="Other">[</span><span class="Identifier">T</span><span class="Other">]</span><span class="Other">(</span><span class="Identifier">t</span><span class="Other">:</span> <span class="Identifier">Time</span><span class="Other">;</span> <span class="Identifier">key</span><span class="Other">:</span> <span class="Identifier">T</span><span class="Other">)</span></pre></dt>
<dd>

This is a trigger that does nothing. This needs to be implemented by you- copy the definition and place it in the same file you instantiate <tt class="docutils literal"><span class="pre"><span class="Identifier">at</span></span></tt> in.

</dd>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2022-06-13 08:00:59 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
